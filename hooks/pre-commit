#!/bin/bash

# ğŸ”§ PRE-COMMIT HOOK - GET WEEZ
# Ce hook s'exÃ©cute avant chaque commit pour vÃ©rifier la qualitÃ© du code

set -e

echo "ğŸ” Pre-commit hook - VÃ©rification du code..."

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction pour les messages colorÃ©s
print_step() {
    echo -e "${BLUE}ğŸ“‹ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# 1. VÃ©rifier que les fichiers modifiÃ©s sont bien formatÃ©s
print_step "VÃ©rification des fichiers modifiÃ©s..."

# Obtenir la liste des fichiers modifiÃ©s (JavaScript/TypeScript seulement)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    print_step "Fichiers JavaScript/TypeScript modifiÃ©s dÃ©tectÃ©s"
    
    # 2. Linting avec ESLint
    print_step "ExÃ©cution de ESLint..."
    if command -v npx &> /dev/null; then
        for FILE in $STAGED_FILES; do
            if [ -f "$FILE" ]; then
                npx eslint "$FILE" --fix || {
                    print_error "ESLint a trouvÃ© des erreurs dans $FILE"
                    echo "Corrigez les erreurs avant de commiter"
                    exit 1
                }
            fi
        done
        print_success "ESLint passed"
    else
        print_warning "ESLint non disponible, passage de cette vÃ©rification"
    fi

    # 3. VÃ©rification de la syntaxe JavaScript/TypeScript
    print_step "VÃ©rification de la syntaxe..."
    for FILE in $STAGED_FILES; do
        if [ -f "$FILE" ]; then
            # VÃ©rifier la syntaxe avec Node.js
            if [[ "$FILE" == *.js || "$FILE" == *.jsx ]]; then
                node -c "$FILE" || {
                    print_error "Erreur de syntaxe JavaScript dans $FILE"
                    exit 1
                }
            fi
        fi
    done
    print_success "Syntaxe JavaScript validÃ©e"
fi

# 4. VÃ©rifier que les secrets ne sont pas commitÃ©es
print_step "VÃ©rification des secrets..."
SECRET_PATTERNS=(
    "OPENAI_API_KEY"
    "SUPABASE_SERVICE_ROLE_KEY" 
    "password"
    "secret"
    "private_key"
    "api_key"
    "token"
)

for PATTERN in "${SECRET_PATTERNS[@]}"; do
    if git diff --cached --name-only | xargs grep -l "$PATTERN" 2>/dev/null | grep -v ".env.example" | grep -v ".gitignore"; then
        print_error "Possible secret dÃ©tectÃ© avec le pattern: $PATTERN"
        print_error "VÃ©rifiez que vous ne commitez pas de donnÃ©es sensibles"
        exit 1
    fi
done
print_success "Aucun secret dÃ©tectÃ©"

# 5. VÃ©rification de la taille des fichiers
print_step "VÃ©rification de la taille des fichiers..."
MAX_SIZE=1048576  # 1MB en bytes
LARGE_FILES=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk -v max=$MAX_SIZE '$5 > max {print $9, $5}' || true)

if [ -n "$LARGE_FILES" ]; then
    print_warning "Fichiers volumineux dÃ©tectÃ©s:"
    echo "$LARGE_FILES"
    print_warning "ConsidÃ©rez utiliser Git LFS pour les gros fichiers"
fi

# 6. Test de build rapide (optionnel - commentÃ© par dÃ©faut car peut Ãªtre long)
# print_step "Test de build rapide..."
# npm run build > /dev/null 2>&1 || {
#     print_error "Le build a Ã©chouÃ©"
#     exit 1
# }
# print_success "Build test rÃ©ussi"

print_success "Toutes les vÃ©rifications pre-commit sont passÃ©es !"
echo -e "${GREEN}ğŸš€ Commit autorisÃ©${NC}"

exit 0