name: ğŸš€ CI/CD Pipeline - Get Weez

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Backup automatique tous les jours Ã  2h du matin UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18.x'
  
jobs:
  # Job 1: Tests et vÃ©rifications de qualitÃ©
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Historique complet pour CodeRabbit

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        
    - name: ğŸ§¹ Code Linting
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint || echo "âš ï¸ ESLint warnings found"
        
    - name: ğŸ”¨ Build Test
      run: |
        echo "ğŸ”¨ Testing build process..."
        npm run build
        
    - name: ğŸ§ª Custom Tests
      run: |
        echo "ğŸ§ª Running custom tests..."
        # VÃ©rifier la syntaxe des fichiers JS/TS
        find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" | \
          grep -v node_modules | \
          grep -v .next | \
          xargs -I {} node -c "require('{}')" 2>/dev/null || echo "Syntax check completed"
        
    - name: ğŸ” Security Scan
      run: |
        echo "ğŸ” Security audit..."
        # VÃ©rifier les vulnÃ©rabilitÃ©s npm
        npm audit --audit-level=moderate || echo "âš ï¸ Security issues found"
        
        # VÃ©rifier qu'aucun secret n'est committÃ©
        echo "ğŸ” Checking for secrets..."
        ! grep -r "sk-" . --exclude-dir=node_modules --exclude-dir=.git || (echo "âŒ OpenAI key detected!" && exit 1)
        ! grep -r "SUPABASE_SERVICE_ROLE_KEY.*=" . --exclude-dir=node_modules --exclude-dir=.git || (echo "âŒ Supabase service key detected!" && exit 1)
        
    - name: ğŸ“Š Code Stats
      run: |
        echo "ğŸ“Š Project Statistics:"
        echo "Files: $(find . -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' | grep -v node_modules | wc -l)"
        echo "Lines: $(find . -name '*.js' -o -name '*.jsx' -o -name '*.ts' -o -name '*.tsx' | grep -v node_modules | xargs wc -l | tail -1 | awk '{print $1}')"
        echo "Size: $(du -sh . --exclude=node_modules | cut -f1)"

  # Job 2: Backup automatique
  backup:
    name: ğŸ’¾ Automated Backup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    needs: quality-checks
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Create Backup Archive
      run: |
        echo "ğŸ’¾ Creating backup archive..."
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        BACKUP_NAME="get-weez_github_backup_${TIMESTAMP}"
        
        # CrÃ©er l'archive sans les dossiers lourds
        tar --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.next' \
            --exclude='*.log' \
            -czf "${BACKUP_NAME}.tar.gz" .
            
        echo "âœ… Backup created: ${BACKUP_NAME}.tar.gz"
        echo "ğŸ“Š Size: $(ls -lh ${BACKUP_NAME}.tar.gz | awk '{print $5}')"

    - name: ğŸ“¤ Upload Backup Artifact
      uses: actions/upload-artifact@v4
      with:
        name: backup-${{ github.sha }}
        path: "*.tar.gz"
        retention-days: 30
        
    - name: ğŸ’¬ Backup Notification
      run: |
        echo "ğŸ‰ Backup completed successfully!"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"

  # Job 3: DÃ©ploiement (seulement sur main)
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: quality-checks
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: ğŸ”¨ Build for production
      run: npm run build

    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      if: env.VERCEL_TOKEN != ''
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    - name: ğŸ“± Deployment notification
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ Environment: Production"
        echo "ğŸ“… Deployed at: $(date)"

  # Job 4: Nettoyage des anciens artifacts
  cleanup:
    name: ğŸ§¹ Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ğŸ§¹ Clean old backups
      run: |
        echo "ğŸ§¹ Cleanup job - removing artifacts older than 30 days"
        echo "This is handled automatically by GitHub Actions retention policy"
        
    - name: ğŸ“Š Storage Info
      run: |
        echo "ğŸ’¾ Current repository size and artifact usage:"
        echo "This cleanup helps maintain optimal performance"